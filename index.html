<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="A notebook-style quote site with search, filters, favorites, and reading mode." />
  <meta name="theme-color" content="#1a1510" />
  <title>Margin Notes</title>

  <style>
    :root{
      /* New palette: ink + parchment + olive */
      --bg:#1a1510;
      --paper:#f4eedf;
      --paper2:#efe4c9;
      --ink:#1b1915;
      --muted:#6b5e4a;
      --line: rgba(27,25,21,.14);

      --olive:#6e8b3d;
      --copper:#c07a43;
      --blue:#3a6ea5;

      --shadow: 0 18px 46px rgba(0,0,0,.45);
      --r: 18px;

      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --serif: ui-serif, Georgia, "Times New Roman", Times, serif;
      --mono: ui-monospace, Menlo, Consolas, "Liberation Mono", monospace;
    }

    [data-mode="night"]{
      --bg:#0f1216;
      --paper:#121824;
      --paper2:#0f1622;
      --ink:#eaf1ff;
      --muted:#a9b7d6;
      --line: rgba(234,241,255,.14);

      --olive:#7ef0a2;
      --copper:#ffb07a;
      --blue:#6aa9ff;

      --shadow: 0 18px 46px rgba(0,0,0,.62);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(900px 700px at 15% 10%, rgba(110,139,61,.14), transparent 55%),
        radial-gradient(900px 600px at 85% 10%, rgba(192,122,67,.12), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%),
        var(--bg);
      color: var(--paper);
      padding: 18px;
    }

    .frame{
      max-width: 1200px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 14px;
      min-height: calc(100vh - 36px);
    }

    @media (max-width: 980px){
      .frame{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
    }

    /* Left: table of contents */
    .tocHead{
      padding: 14px;
      border-bottom: 1px solid rgba(255,255,255,.12);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .brand h1{
      margin:0;
      font-size: 22px;
      letter-spacing:-.02em;
      line-height:1.05;
    }

    .brand p{
      margin:0;
      color: rgba(244,238,223,.72);
      font-size: 13px;
      line-height:1.35;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }

    .label{
      font-family: var(--mono);
      font-size:11px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: rgba(244,238,223,.70);
    }

    input, select{
      width:100%;
      padding: 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--paper);
      outline:none;
      font-size: 14px;
    }
    input::placeholder{ color: rgba(244,238,223,.55); }

    input:focus, select:focus{
      border-color: rgba(110,139,61,.75);
      box-shadow: 0 0 0 4px rgba(110,139,61,.18);
    }

    .tocList{
      padding: 10px;
      max-height: 560px;
      overflow:auto;
    }
    @media (max-width: 980px){
      .tocList{ max-height: 260px; }
    }

    .tocItem{
      border:1px solid transparent;
      border-radius: 16px;
      padding: 10px 12px;
      cursor:pointer;
      transition: background .12s ease, border-color .12s ease, transform .06s ease;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .tocItem:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(58,110,165,.35);
    }
    .tocItem:active{ transform: translateY(1px); }
    .tocItem.active{
      background: rgba(110,139,61,.14);
      border-color: rgba(110,139,61,.55);
    }

    .tocItem .line{
      font-size: 13px;
      line-height:1.25;
      color: rgba(244,238,223,.92);
    }
    .tocItem .meta{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(244,238,223,.62);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .star{ color: var(--copper); font-weight: 900; }

    /* Right: notebook page */
    .page{
      background: var(--paper);
      color: var(--ink);
      border: 1px solid rgba(255,255,255,.10);
    }
    [data-mode="night"] .page{
      border-color: rgba(234,241,255,.14);
    }

    .pageTop{
      padding: 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      background: linear-gradient(180deg, rgba(0,0,0,.03), transparent);
    }
    [data-mode="night"] .pageTop{
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
    }

    .now{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .now .title{
      font-weight: 950;
      letter-spacing:-.02em;
      font-size: 14px;
    }
    .now .sub{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    .tools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.04);
      color: var(--ink);
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 950;
      font-size: 13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .btn:hover{
      border-color: rgba(58,110,165,.65);
      background: rgba(58,110,165,.08);
    }
    .btn:active{ transform: translateY(1px); }

    .btn.good:hover{ border-color: rgba(110,139,61,.75); background: rgba(110,139,61,.10); }
    .btn.warn:hover{ border-color: rgba(192,122,67,.80); background: rgba(192,122,67,.10); }

    .pageBody{
      padding: 18px;
      display:grid;
      grid-template-columns: 1fr 260px;
      gap: 16px;
      align-items:start;
    }

    @media (max-width: 980px){
      .pageBody{ grid-template-columns: 1fr; }
    }

    .sheet{
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 18px;
      background: var(--paper2);
      position:relative;
      overflow:hidden;
    }
    [data-mode="night"] .sheet{
      background: var(--paper2);
    }

    .sheet::before{
      content:"";
      position:absolute;
      left:0; top:0;
      width:100%;
      height:8px;
      background: linear-gradient(90deg, var(--olive), var(--blue), var(--copper));
      opacity:.85;
    }

    .quote{
      margin: 0;
      font-family: var(--serif);
      font-size: clamp(22px, 2.8vw, 40px);
      line-height:1.18;
      letter-spacing:-.01em;
    }

    .info{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
    }

    .tags{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .tag{
      border:1px solid var(--line);
      background: rgba(0,0,0,.03);
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
    }

    .margin{
      border: 1px dashed var(--line);
      border-radius: 18px;
      padding: 14px;
      background: rgba(0,0,0,.02);
    }
    .margin h3{
      margin:0 0 10px 0;
      font-size: 13px;
      letter-spacing:.08em;
      text-transform: uppercase;
      font-family: var(--mono);
      color: var(--muted);
    }
    .note{
      font-size: 13px;
      line-height:1.45;
      color: var(--ink);
      opacity:.90;
    }
    [data-mode="night"] .note{ color: var(--ink); }

    .krow{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .slider{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      margin-top: 10px;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
    }
    input[type="range"]{
      width: 100%;
      accent-color: var(--olive);
    }

    .statusBar{
      padding: 10px 14px;
      border-top: 1px solid var(--line);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
      background: rgba(0,0,0,.02);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.78);
      color: white;
      border: 1px solid rgba(255,255,255,.16);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 999;
      max-width: min(980px, calc(100% - 24px));
      text-align:center;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }
  </style>
</head>

<body>
  <div class="frame">
    <!-- LEFT: TOC -->
    <section class="card">
      <div class="tocHead">
        <div class="brand">
          <h1>Margin Notes</h1>
          <p>A notebook-style reader: search, filter, favorite, copy, shuffle, reading mode, and export.</p>
        </div>

        <div class="field">
          <div class="label">Search</div>
          <input id="search" placeholder="Search word, theme, book‚Ä¶" />
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div class="field" style="flex:1; min-width: 140px;">
            <div class="label">Book</div>
            <select id="bookFilter"></select>
          </div>
          <div class="field" style="flex:1; min-width: 140px;">
            <div class="label">Theme</div>
            <select id="themeFilter"></select>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div class="field" style="flex:1; min-width: 140px;">
            <div class="label">View</div>
            <select id="viewMode">
              <option value="all">All quotes</option>
              <option value="favorites">Favorites only</option>
            </select>
          </div>
          <div class="field" style="flex:1; min-width: 140px;">
            <div class="label">Sort</div>
            <select id="sortMode">
              <option value="mix">Mixed</option>
              <option value="book">Book</option>
              <option value="short">Shortest</option>
              <option value="long">Longest</option>
            </select>
          </div>
        </div>
      </div>

      <div class="tocList" id="tocList"></div>
    </section>

    <!-- RIGHT: PAGE -->
    <section class="card page">
      <div class="pageTop">
        <div class="now">
          <div class="title" id="nowTitle">Select a quote</div>
          <div class="sub" id="nowMeta">‚Äî</div>
        </div>

        <div class="tools">
          <button class="btn" id="prevBtn">‚Üê Prev</button>
          <button class="btn" id="nextBtn">Next ‚Üí</button>
          <button class="btn good" id="shuffleBtn">‚ü≤ Shuffle</button>
          <button class="btn" id="copyBtn">‚ßâ Copy</button>
          <button class="btn warn" id="favBtn">‚òÜ Save</button>
          <button class="btn" id="exportBtn">‚á© Export</button>
          <button class="btn" id="printBtn">üñ® Print</button>
          <button class="btn" id="musicBtn">‚ñ∂ Audio</button>
          <button class="btn" id="modeBtn">‚òæ / ‚òº</button>
        </div>
      </div>

      <div class="pageBody">
        <div class="sheet">
          <p class="quote" id="quoteText">Pick a quote on the left to start reading.</p>
          <div class="info" id="quoteInfo"></div>
          <div class="tags" id="quoteTags"></div>

          <div class="krow">
            <div class="slider">
              <span>Text size</span>
              <input id="sizeRange" type="range" min="18" max="48" value="32" />
              <span id="sizeLabel">32px</span>
            </div>
          </div>

          <!-- Optional audio (click to play; no autoplay) -->
          <audio id="audio" preload="none" crossorigin="anonymous">
            <source src="https://files.freemusicarchive.org/storage-freemusicarchive-org/music/no_curator/Kai_Engel/Irsens_Tale/Kai_Engel_-_03_-_Wake_Up.mp3" type="audio/mpeg">
          </audio>
        </div>

        <aside class="margin">
          <h3>Margin notes</h3>
          <div class="note" id="marginNote">
            This panel changes with the quote. It‚Äôs meant to show a short ‚Äúthinking prompt‚Äù for what the line suggests.
          </div>
        </aside>
      </div>

      <div class="statusBar">
        <div id="statusLeft">0 shown ‚Ä¢ 0 saved</div>
        <div id="statusRight">Keys: ‚Üë/‚Üì navigate ‚Ä¢ C copy ‚Ä¢ F save ‚Ä¢ S shuffle ‚Ä¢ M music</div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Your quote is included EXACTLY as you typed it (unchanged).
    // Other quotes are original "Collection" lines in a similar theme to avoid misquoting books.
    const quotes = [
      { id:"c1", text:"I read until the sentences stopped being information and started being questions.", book:"Collection", author:"", cite:"", themes:["reading","questions","seeking"], note:"How does reading become more than learning‚Äîmore like searching?" },
      { id:"c2", text:"I tried to pray with my mind open, but my thoughts crowded the words.", book:"Collection", author:"", cite:"", themes:["prayer","thoughts","uncertainty"], note:"What happens when belief and doubt show up at the same time?" },
      { id:"c3", text:"Study felt like building a ladder, and every page was another rung.", book:"Collection", author:"", cite:"", themes:["study","hope","effort"], note:"What is the ‚Äòheight‚Äô the speaker is trying to reach?" },

      { id:"wiesel-4",
        text:"I read, I studied, I prayed... I wanted to ask him the questions that thronged my mind",
        book:"Night",
        author:"Elie Wiesel",
        cite:"(Wiesel 4)",
        themes:["reading","study","prayer","questions"],
        note:"Notice the repetition. What does it show about urgency and need?"
      },

      { id:"c4", text:"He had answers for everyone else, but he saved his real questions for the dark.", book:"Collection", author:"", cite:"", themes:["questions","silence","fear"], note:"Why do people hide certain questions even from friends?" },
      { id:"c5", text:"He wanted a teacher, not to be told what to think, but to be shown how to ask.", book:"Collection", author:"", cite:"", themes:["learning","questions","guidance"], note:"What is the difference between knowledge and wisdom here?" },
      { id:"c6", text:"Faith was supposed to be steady, but his mind kept moving.", book:"Collection", author:"", cite:"", themes:["faith","uncertainty","mind"], note:"Is movement a weakness‚Äîor part of being human?" },
      { id:"c7", text:"The more he learned, the more the world refused to simplify.", book:"Collection", author:"", cite:"", themes:["study","complexity","truth"], note:"What topic in your life got more complicated the more you learned?" },
      { id:"c8", text:"He carried his questions like stones‚Äîsmall ones at first, then heavier.", book:"Collection", author:"", cite:"", themes:["questions","burden","growth"], note:"Which questions grow heavier over time, and why?" },
      { id:"c9", text:"He prayed for clarity, but what he received was courage.", book:"Collection", author:"", cite:"", themes:["prayer","courage","uncertainty"], note:"Sometimes the ‚Äòanswer‚Äô is not information, but strength." },
      { id:"c10", text:"He studied as if his life depended on it, because in a way, it did.", book:"Collection", author:"", cite:"", themes:["study","survival","effort"], note:"How can learning become an act of survival or identity?" }
    ];

    const els = {
      search: document.getElementById("search"),
      bookFilter: document.getElementById("bookFilter"),
      themeFilter: document.getElementById("themeFilter"),
      viewMode: document.getElementById("viewMode"),
      sortMode: document.getElementById("sortMode"),
      tocList: document.getElementById("tocList"),

      nowTitle: document.getElementById("nowTitle"),
      nowMeta: document.getElementById("nowMeta"),
      quoteText: document.getElementById("quoteText"),
      quoteInfo: document.getElementById("quoteInfo"),
      quoteTags: document.getElementById("quoteTags"),
      marginNote: document.getElementById("marginNote"),

      prevBtn: document.getElementById("prevBtn"),
      nextBtn: document.getElementById("nextBtn"),
      shuffleBtn: document.getElementById("shuffleBtn"),
      copyBtn: document.getElementById("copyBtn"),
      favBtn: document.getElementById("favBtn"),
      exportBtn: document.getElementById("exportBtn"),
      printBtn: document.getElementById("printBtn"),
      modeBtn: document.getElementById("modeBtn"),
      musicBtn: document.getElementById("musicBtn"),

      sizeRange: document.getElementById("sizeRange"),
      sizeLabel: document.getElementById("sizeLabel"),

      statusLeft: document.getElementById("statusLeft"),
      toast: document.getElementById("toast"),

      audio: document.getElementById("audio"),
    };

    const storage = {
      getMode: () => localStorage.getItem("mn_mode") || "day",
      setMode: (m) => localStorage.setItem("mn_mode", m),
      getFavs: () => {
        try { return JSON.parse(localStorage.getItem("mn_favs") || "[]"); }
        catch { return []; }
      },
      setFavs: (arr) => localStorage.setItem("mn_favs", JSON.stringify(arr)),
      getSize: () => Number(localStorage.getItem("mn_size") || "32"),
      setSize: (n) => localStorage.setItem("mn_size", String(n)),
    };

    let favorites = new Set(storage.getFavs());
    let currentId = null;

    function showToast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => els.toast.classList.remove("show"), 1500);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;", "\"":"&quot;","'":"&#039;"
      })[s]);
    }

    function uniq(arr){ return Array.from(new Set(arr)).sort((a,b)=>a.localeCompare(b)); }

    function matchesQuery(q, item){
      if(!q) return true;
      const hay = [item.text, item.book, item.author, item.cite || "", ...(item.themes || [])].join(" ").toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function buildFilters(){
      const books = uniq(quotes.map(q => q.book));
      const themes = uniq(quotes.flatMap(q => q.themes || []));

      els.bookFilter.innerHTML =
        `<option value="">All books</option>` +
        books.map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join("");

      els.themeFilter.innerHTML =
        `<option value="">All themes</option>` +
        themes.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
    }

    function getFiltered(){
      const q = (els.search.value || "").trim();
      const book = els.bookFilter.value;
      const theme = els.themeFilter.value;
      const mode = els.viewMode.value;

      let list = quotes.filter(item => {
        if(mode === "favorites" && !favorites.has(item.id)) return false;
        if(book && item.book !== book) return false;
        if(theme && !(item.themes || []).includes(theme)) return false;
        return matchesQuery(q, item);
      });

      const sort = els.sortMode.value;
      if(sort === "book") list = list.slice().sort((a,b)=> (a.book||"").localeCompare(b.book||""));
      if(sort === "short") list = list.slice().sort((a,b)=> a.text.length - b.text.length);
      if(sort === "long") list = list.slice().sort((a,b)=> b.text.length - a.text.length);

      // "mix" keeps original order
      return list;
    }

    function renderTOC(){
      const list = getFiltered();
      els.statusLeft.textContent = `${list.length} shown ‚Ä¢ ${favorites.size} saved`;

      if(list.length === 0){
        els.tocList.innerHTML = `<div style="padding:14px;color:rgba(244,238,223,.72);font-family:var(--mono);font-size:12px;">
          No results. Clear filters or search broader.
        </div>`;
        return;
      }

      if(!currentId || !list.some(x => x.id === currentId)){
        currentId = list[0].id;
      }

      els.tocList.innerHTML = list.map(item => {
        const active = item.id === currentId ? "active" : "";
        const star = favorites.has(item.id) ? `<span class="star">‚òÖ</span>` : "";
        const preview = item.text.length > 70 ? item.text.slice(0,70) + "‚Ä¶" : item.text;
        const t0 = item.themes?.[0] || "theme";
        return `
          <div class="tocItem ${active}" data-id="${escapeHtml(item.id)}">
            <div class="line">${star} ${escapeHtml(preview)}</div>
            <div class="meta">
              <span>${escapeHtml(item.book)}</span>
              <span>${escapeHtml(t0)}</span>
            </div>
          </div>
        `;
      }).join("");

      renderPage(currentId);
    }

    function renderPage(id){
      const item = quotes.find(x => x.id === id);
      if(!item) return;
      currentId = id;

      els.nowTitle.textContent = item.book || "Quote";
      const metaBits = [];
      if(item.author) metaBits.push(item.author);
      if(item.cite) metaBits.push(item.cite);
      els.nowMeta.textContent = metaBits.length ? metaBits.join(" ‚Ä¢ ") : "‚Äî";

      els.quoteText.textContent = `‚Äú${item.text}‚Äù`;

      const info = [];
      info.push(`<span><b>Book:</b> ${escapeHtml(item.book || "‚Äî")}</span>`);
      info.push(`<span><b>Author:</b> ${escapeHtml(item.author || "‚Äî")}</span>`);
      info.push(`<span><b>Citation:</b> ${escapeHtml(item.cite || "‚Äî")}</span>`);
      els.quoteInfo.innerHTML = info.join(" ‚Ä¢ ");

      els.quoteTags.innerHTML = (item.themes || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("");

      els.marginNote.textContent = item.note || "Think about what the speaker wants, and what stands in the way.";

      const faved = favorites.has(item.id);
      els.favBtn.textContent = (faved ? "‚òÖ" : "‚òÜ") + " Save";

      // highlight in list
      const nodes = els.tocList.querySelectorAll(".tocItem");
      nodes.forEach(n => n.classList.toggle("active", n.getAttribute("data-id") === id));
    }

    function step(delta){
      const list = getFiltered();
      if(list.length === 0) return;
      const idx = Math.max(0, list.findIndex(x => x.id === currentId));
      const next = (idx + delta + list.length) % list.length;
      const target = list[next];
      renderPage(target.id);
      const el = els.tocList.querySelector(`.tocItem[data-id="${CSS.escape(target.id)}"]`);
      if(el) el.scrollIntoView({block:"nearest"});
    }

    function shuffle(){
      const list = getFiltered();
      if(list.length === 0) return;
      const pick = list[Math.floor(Math.random() * list.length)];
      renderPage(pick.id);
      showToast("Shuffled");
    }

    function toggleFavorite(){
      if(!currentId) return;
      if(favorites.has(currentId)) favorites.delete(currentId);
      else favorites.add(currentId);
      storage.setFavs(Array.from(favorites));
      renderTOC();
      showToast(favorites.has(currentId) ? "Saved" : "Removed");
    }

    function fallbackCopy(text){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand("copy"); } catch(e){}
      document.body.removeChild(ta);
    }

    async function copyCurrent(){
      const item = quotes.find(x => x.id === currentId);
      if(!item) return;
      const cite = item.cite ? " " + item.cite : "";
      const author = item.author ? item.author + ", " : "";
      const text = `"${item.text}" ‚Äî ${author}${item.book}${cite}`.trim();

      try{
        if(navigator.clipboard && navigator.clipboard.writeText) await navigator.clipboard.writeText(text);
        else fallbackCopy(text);
        showToast("Copied!");
      }catch{
        fallbackCopy(text);
        showToast("Copied!");
      }
    }

    function exportFavorites(){
      const favList = quotes.filter(q => favorites.has(q.id));
      if(favList.length === 0){
        showToast("No saved quotes to export");
        return;
      }

      const lines = favList.map(q => {
        const cite = q.cite ? " " + q.cite : "";
        const author = q.author ? q.author + ", " : "";
        return `"${q.text}" ‚Äî ${author}${q.book}${cite}`.trim();
      });

      const blob = new Blob([lines.join("\n\n")], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "saved-quotes.txt";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      showToast("Exported saved-quotes.txt");
    }

    function toggleMode(){
      const cur = document.documentElement.getAttribute("data-mode") || "day";
      const next = cur === "night" ? "day" : "night";
      if(next === "night") document.documentElement.setAttribute("data-mode","night");
      else document.documentElement.removeAttribute("data-mode");
      storage.setMode(next);
      showToast("Mode: " + next);
    }

    function initMode(){
      const m = storage.getMode();
      if(m === "night") document.documentElement.setAttribute("data-mode","night");
      else document.documentElement.removeAttribute("data-mode");
    }

    function applySize(n){
      const px = Math.max(18, Math.min(48, Number(n) || 32));
      els.quoteText.style.fontSize = px + "px";
      els.sizeLabel.textContent = px + "px";
      els.sizeRange.value = String(px);
      storage.setSize(px);
    }

    async function toggleMusic(){
      try{
        if(els.audio.paused){
          await els.audio.play();
          els.musicBtn.textContent = "‚è∏ Audio";
          showToast("Audio playing");
        }else{
          els.audio.pause();
          els.musicBtn.textContent = "‚ñ∂ Audio";
          showToast("Audio paused");
        }
      }catch(e){
        console.error(e);
        showToast("Audio blocked by browser‚Äîclick again or use a different mp3 link.");
      }
    }

    function wire(){
      els.search.addEventListener("input", renderTOC);
      els.bookFilter.addEventListener("change", renderTOC);
      els.themeFilter.addEventListener("change", renderTOC);
      els.viewMode.addEventListener("change", renderTOC);
      els.sortMode.addEventListener("change", renderTOC);

      els.tocList.addEventListener("click", (e) => {
        const item = e.target.closest(".tocItem");
        if(!item) return;
        renderPage(item.getAttribute("data-id"));
      });

      els.prevBtn.addEventListener("click", () => step(-1));
      els.nextBtn.addEventListener("click", () => step(1));
      els.shuffleBtn.addEventListener("click", shuffle);
      els.copyBtn.addEventListener("click", copyCurrent);
      els.favBtn.addEventListener("click", toggleFavorite);
      els.exportBtn.addEventListener("click", exportFavorites);
      els.printBtn.addEventListener("click", () => window.print());
      els.modeBtn.addEventListener("click", toggleMode);
      els.musicBtn.addEventListener("click", toggleMusic);

      els.sizeRange.addEventListener("input", () => applySize(els.sizeRange.value));

      window.addEventListener("keydown", (e) => {
        if(e.target && (e.target.tagName === "INPUT" || e.target.tagName === "SELECT" || e.target.tagName === "TEXTAREA")) return;

        if(e.key === "ArrowUp"){ e.preventDefault(); step(-1); }
        if(e.key === "ArrowDown"){ e.preventDefault(); step(1); }
        if(e.key.toLowerCase() === "c"){ copyCurrent(); }
        if(e.key.toLowerCase() === "f"){ toggleFavorite(); }
        if(e.key.toLowerCase() === "s"){ shuffle(); }
        if(e.key.toLowerCase() === "m"){ toggleMusic(); }
      });
    }

    // Boot
    (function boot(){
      initMode();
      buildFilters();
      wire();
      applySize(storage.getSize());
      currentId = getFiltered()[0]?.id || quotes[0].id;
      renderTOC();
    })();
  </script>
</body>
</html>
