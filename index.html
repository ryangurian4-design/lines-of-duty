<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="An infinite moving quote stream with focus view, favorites, and search." />
  <title>Questions That Throng</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,500,700&family=IBM+Plex+Mono:wght@400;600&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b0f17;
      --card: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.14);
      --ink: #f2f5ff;
      --muted: rgba(242,245,255,.72);

      --a: #8b5cf6;   /* violet */
      --b: #22c55e;   /* green */
      --c: #06b6d4;   /* cyan */
      --d: #f59e0b;   /* amber */

      --shadow: 0 18px 55px rgba(0,0,0,.55);
      --r: 18px;

      --serif: "Fraunces", serif;
      --sans: "Plus Jakarta Sans", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      --mono: "IBM Plex Mono", ui-monospace, Menlo, Consolas, monospace;
    }

    [data-theme="light"]{
      --bg: #f7f8fb;
      --card: rgba(10,16,28,.05);
      --line: rgba(10,16,28,.14);
      --ink: #0a101c;
      --muted: rgba(10,16,28,.62);
      --shadow: 0 18px 55px rgba(10,16,28,.14);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      background:
        radial-gradient(900px 520px at 12% 12%, rgba(139,92,246,.18), transparent 55%),
        radial-gradient(900px 520px at 88% 14%, rgba(6,182,212,.16), transparent 55%),
        radial-gradient(900px 520px at 55% 92%, rgba(245,158,11,.12), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg));
      color: var(--ink);
      font-family: var(--sans);
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 22px 16px 120px;
    }

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 14px;
    }

    h1{
      margin:0;
      font-family: var(--serif);
      font-size: clamp(28px, 3.3vw, 54px);
      letter-spacing: -0.02em;
      line-height:1.05;
    }

    .sub{
      margin:10px 0 0;
      color: var(--muted);
      max-width: 78ch;
      font-size: 14px;
      line-height:1.55;
    }

    .panel{
      display:grid;
      grid-template-columns: 1.4fr .8fr .8fr;
      gap:10px;
      margin-top: 14px;
      margin-bottom: 18px;
    }
    @media (max-width: 980px){
      header{ flex-direction:column; align-items:flex-start; }
      .panel{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0 0 6px 4px;
    }

    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      outline:none;
      font-size: 14px;
      box-shadow: var(--shadow);
    }
    [data-theme="light"] input,
    [data-theme="light"] select{
      background: rgba(255,255,255,.75);
    }

    input:focus, select:focus{
      border-color: rgba(139,92,246,.75);
      box-shadow: 0 0 0 4px rgba(139,92,246,.18), var(--shadow);
    }

    /* Moving lanes */
    .lanes{
      display:grid;
      gap: 14px;
      margin-top: 10px;
    }

    .lane{
      position: relative;
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.16));
      box-shadow: var(--shadow);
      overflow:hidden;
      padding: 10px 0;
    }
    [data-theme="light"] .lane{
      background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.35));
    }

    .fadeLeft,.fadeRight{
      position:absolute;
      top:0; bottom:0;
      width: 64px;
      pointer-events:none;
      z-index:2;
    }
    .fadeLeft{
      left:0;
      background: linear-gradient(90deg, rgba(11,15,23,1), rgba(11,15,23,0));
    }
    .fadeRight{
      right:0;
      background: linear-gradient(270deg, rgba(11,15,23,1), rgba(11,15,23,0));
    }
    [data-theme="light"] .fadeLeft{
      background: linear-gradient(90deg, rgba(247,248,251,1), rgba(247,248,251,0));
    }
    [data-theme="light"] .fadeRight{
      background: linear-gradient(270deg, rgba(247,248,251,1), rgba(247,248,251,0));
    }

    .track{
      display:flex;
      gap: 10px;
      width: max-content;
      will-change: transform;
      padding: 0 64px;
    }

    /* Duplicate content for seamless loop */
    .run{
      display:flex;
      gap: 10px;
      width: max-content;
      align-items:center;
    }

    .chip{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      padding: 10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      max-width: min(88vw, 780px);
    }
    .chip:hover{ border-color: rgba(34,197,94,.65); }
    .chip:active{ transform: translateY(1px); }

    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: var(--c);
      box-shadow: 0 0 0 4px rgba(6,182,212,.16);
      flex: 0 0 auto;
    }
    .dot.v{ background: var(--a); box-shadow: 0 0 0 4px rgba(139,92,246,.16); }
    .dot.g{ background: var(--b); box-shadow: 0 0 0 4px rgba(34,197,94,.14); }
    .dot.y{ background: var(--d); box-shadow: 0 0 0 4px rgba(245,158,11,.14); }

    .qtext{
      font-size: 14px;
      line-height: 1.2;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .meta{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      opacity:.95;
    }

    /* Animations (pause on hover) */
    .lane:hover .track{ animation-play-state: paused; }

    @keyframes leftward{
      from { transform: translateX(0); }
      to   { transform: translateX(-50%); }
    }
    @keyframes rightward{
      from { transform: translateX(-50%); }
      to   { transform: translateX(0); }
    }

    /* Bottom dock */
    .dock{
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      width: min(980px, calc(100% - 24px));
      border: 1px solid var(--line);
      border-radius: 22px;
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      padding: 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      z-index: 999;
    }
    [data-theme="light"] .dock{
      background: rgba(255,255,255,.72);
    }

    .count{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      white-space:nowrap;
    }

    .btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--ink);
      border-radius: 16px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-family: var(--mono);
      transition: transform .08s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{ border-color: rgba(6,182,212,.65); }
    .btn:active{ transform: translateY(1px); }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.65);
      padding: 18px;
      z-index: 1000;
    }
    .overlay.show{ display:flex; }

    .modal{
      width: min(920px, 100%);
      border: 1px solid var(--line);
      border-radius: 24px;
      background:
        radial-gradient(900px 380px at 20% 0%, rgba(139,92,246,.14), transparent 60%),
        radial-gradient(900px 380px at 85% 0%, rgba(34,197,94,.12), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    [data-theme="light"] .modal{
      background:
        radial-gradient(900px 380px at 20% 0%, rgba(139,92,246,.14), transparent 60%),
        radial-gradient(900px 380px at 85% 0%, rgba(34,197,94,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.35));
    }

    .modalTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
    }

    .mTitle{
      font-family: var(--mono);
      font-size: 12px;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .x{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 900;
      font-family: var(--mono);
    }

    .modalBody{
      padding: 16px;
    }

    .bigQuote{
      margin: 0;
      font-family: var(--serif);
      font-size: clamp(22px, 2.8vw, 44px);
      line-height: 1.16;
      letter-spacing: -0.02em;
    }

    .mMeta{
      margin-top: 14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 12px;
      align-items:center;
    }

    .pill{
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 7px 10px;
      background: rgba(255,255,255,.04);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 92px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.82);
      color: white;
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 1200;
      max-width: min(980px, calc(100% - 24px));
      text-align:center;
      font-family: var(--mono);
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Questions That Throng</h1>
        <p class="sub">A moving stream of lines about reading, studying, praying, and the pressure of unanswered questions. Hover a lane to pause it. Click a quote to open it.</p>
      </div>
    </header>

    <div class="panel">
      <div>
        <label for="search">Search</label>
        <input id="search" placeholder="Try: prayer, questions, study, reading…" />
      </div>
      <div>
        <label for="book">Book</label>
        <select id="book"></select>
      </div>
      <div>
        <label for="view">View</label>
        <select id="view">
          <option value="all">All</option>
          <option value="favorites">Favorites</option>
        </select>
      </div>
    </div>

    <div class="lanes" id="lanes"></div>
  </div>

  <div class="dock">
    <div class="count" id="count">0 shown</div>
    <div class="btns">
      <button class="btn" id="theme">Theme</button>
      <button class="btn" id="shuffle">Shuffle</button>
      <button class="btn" id="copy">Copy</button>
      <button class="btn" id="fav">Favorite</button>
    </div>
  </div>

  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <div class="mTitle" id="mTitle">Focus</div>
        <button class="x" id="close">Close</button>
      </div>
      <div class="modalBody">
        <p class="bigQuote" id="mQuote"></p>
        <div class="mMeta" id="mMeta"></div>
        <div class="btns" style="margin-top:14px;">
          <button class="btn" id="mCopy">Copy</button>
          <button class="btn" id="mFav">Favorite</button>
          <button class="btn" id="mNext">Next</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Your provided quote remains EXACTLY as typed (unchanged).
    // Additional entries are mostly original lines in a similar theme-set, plus a few short, properly attributed quotes.

    const QUOTES = [
      // original (similar themes)
      { id:"o1", text:"He read like the page was a doorway, and he needed it to open.", book:"Original", author:"—", cite:"", tags:["reading","seeking"] },
      { id:"o2", text:"Studying felt like building a ladder in the dark—slow, careful, necessary.", book:"Original", author:"—", cite:"", tags:["study","persistence"] },
      { id:"o3", text:"Prayer didn’t remove the questions; it kept him standing under them.", book:"Original", author:"—", cite:"", tags:["prayer","questions"] },
      { id:"o4", text:"The more he learned, the more he noticed what he could not explain.", book:"Original", author:"—", cite:"", tags:["learning","questions"] },
      { id:"o5", text:"He wanted answers, but he settled first for clarity.", book:"Original", author:"—", cite:"", tags:["clarity","questions"] },
      { id:"o6", text:"He studied to survive the day, and read to survive himself.", book:"Original", author:"—", cite:"", tags:["study","reading"] },
      { id:"o7", text:"Some questions arrive like crowds; you don’t choose them, you endure them.", book:"Original", author:"—", cite:"", tags:["questions","pressure"] },
      { id:"o8", text:"He prayed in fragments, because whole sentences felt dishonest.", book:"Original", author:"—", cite:"", tags:["prayer","doubt"] },
      { id:"o9", text:"He read for comfort and found responsibility instead.", book:"Original", author:"—", cite:"", tags:["reading","responsibility"] },
      { id:"o10", text:"Studying became a way to keep panic from taking up all the space.", book:"Original", author:"—", cite:"", tags:["study","fear"] },
      { id:"o11", text:"He asked questions to stay human.", book:"Original", author:"—", cite:"", tags:["questions","identity"] },
      { id:"o12", text:"He carried his uncertainty like a book he couldn’t put down.", book:"Original", author:"—", cite:"", tags:["uncertainty","reading"] },
      { id:"o13", text:"He wanted someone wise enough to sit beside a question without rushing it.", book:"Original", author:"—", cite:"", tags:["questions","learning"] },
      { id:"o14", text:"He studied as if knowledge could become a shelter.", book:"Original", author:"—", cite:"", tags:["study","hope"] },
      { id:"o15", text:"He prayed not for answers, but for the strength to keep asking.", book:"Original", author:"—", cite:"", tags:["prayer","questions"] },
      { id:"o16", text:"Each page turned into another reason to keep going.", book:"Original", author:"—", cite:"", tags:["reading","endurance"] },
      { id:"o17", text:"He learned that doubt and honesty sometimes share the same voice.", book:"Original", author:"—", cite:"", tags:["doubt","truth"] },
      { id:"o18", text:"He read until the words stopped being words and started being weight.", book:"Original", author:"—", cite:"", tags:["reading","gravity"] },
      { id:"o19", text:"Studying was his way of refusing to go numb.", book:"Original", author:"—", cite:"", tags:["study","resistance"] },
      { id:"o20", text:"Prayer became the place he put what he couldn’t carry alone.", book:"Original", author:"—", cite:"", tags:["prayer","burden"] },

      // your provided quote (unchanged, not first)
      {
        id:"wiesel4",
        text:"I read, I studied, I prayed...I wanted to ask him the questions that thronged my mind",
        book:"Night",
        author:"Elie Wiesel",
        cite:"(Wiesel 4)",
        tags:["reading","study","prayer","questions"]
      },

      // short, properly attributed quotes (kept brief)
      { id:"aug1", text:"“Our heart is restless until it rests in you.”", book:"Confessions", author:"St. Augustine", cite:"", tags:["restless","seeking"] },
      { id:"k1", text:"“Prayer… changes the nature of the one who prays.”", book:"Upbuilding Discourses", author:"Søren Kierkegaard", cite:"", tags:["prayer","change"] },
      { id:"em1", text:"“’Tis the good reader that makes the good book.”", book:"Essay/Attributed", author:"Ralph Waldo Emerson", cite:"", tags:["reading","meaning"] },
    ];

    const els = {
      lanes: document.getElementById("lanes"),
      search: document.getElementById("search"),
      book: document.getElementById("book"),
      view: document.getElementById("view"),
      count: document.getElementById("count"),
      theme: document.getElementById("theme"),
      shuffle: document.getElementById("shuffle"),
      copy: document.getElementById("copy"),
      fav: document.getElementById("fav"),

      overlay: document.getElementById("overlay"),
      close: document.getElementById("close"),
      mTitle: document.getElementById("mTitle"),
      mQuote: document.getElementById("mQuote"),
      mMeta: document.getElementById("mMeta"),
      mCopy: document.getElementById("mCopy"),
      mFav: document.getElementById("mFav"),
      mNext: document.getElementById("mNext"),

      toast: document.getElementById("toast"),
    };

    const storage = {
      getTheme: () => localStorage.getItem("qt_theme") || "dark",
      setTheme: (t) => localStorage.setItem("qt_theme", t),
      getFavs: () => {
        try { return JSON.parse(localStorage.getItem("qt_favs") || "[]"); }
        catch { return []; }
      },
      setFavs: (arr) => localStorage.setItem("qt_favs", JSON.stringify(arr))
    };

    let favorites = new Set(storage.getFavs());
    let currentId = null;

    function showToast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => els.toast.classList.remove("show"), 1400);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      })[s]);
    }

    function uniq(arr){ return Array.from(new Set(arr)).sort((a,b)=>a.localeCompare(b)); }

    function buildBookFilter(items){
      const books = uniq(items.map(q => q.book));
      els.book.innerHTML =
        `<option value="">All books</option>` +
        books.map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join("");
    }

    function matches(q, item){
      if(!q) return true;
      const hay = [item.text, item.book, item.author, item.cite || "", ...(item.tags||[])].join(" ").toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function filtered(){
      const q = (els.search.value || "").trim();
      const book = els.book.value;
      const view = els.view.value;

      return QUOTES.filter(item => {
        if(book && item.book !== book) return false;
        if(view === "favorites" && !favorites.has(item.id)) return false;
        return matches(q, item);
      });
    }

    function pickDot(i){
      const mods = ["v","g","y",""];
      return mods[i % mods.length];
    }

    // Build moving lanes from the filtered list
    function render(){
      const list = filtered();
      els.count.textContent = `${list.length} shown`;

      if(!currentId || !list.some(x => x.id === currentId)){
        // pick something NOT the Wiesel quote first when possible
        currentId = list.find(x => x.id !== "wiesel4")?.id || list[0]?.id || null;
      }

      if(list.length === 0){
        els.lanes.innerHTML = `
          <div class="lane">
            <div class="fadeLeft"></div><div class="fadeRight"></div>
            <div class="track" style="padding:0 18px;">
              <div class="chip" style="max-width:none;">
                <span class="dot g"></span>
                <div>
                  <div class="qtext">No results. Try clearing filters.</div>
                  <div class="meta">Tip: remove the book filter or search term.</div>
                </div>
              </div>
            </div>
          </div>`;
        return;
      }

      // Split list into 4 lanes for visual variety
      const lanes = 4;
      const buckets = Array.from({length: lanes}, () => []);
      list.forEach((q, i) => buckets[i % lanes].push(q));

      els.lanes.innerHTML = buckets.map((bucket, laneIndex) => {
        // Duplicate the run for seamless loop
        const chips = bucket.map((q, i) => chipHTML(q, laneIndex*100 + i)).join("");
        const duration = 38 + laneIndex * 10;        // different speeds
        const dir = (laneIndex % 2 === 0) ? "leftward" : "rightward";

        return `
          <div class="lane" data-lane="${laneIndex}">
            <div class="fadeLeft"></div>
            <div class="fadeRight"></div>
            <div class="track" style="animation:${dir} ${duration}s linear infinite;">
              <div class="run">${chips}</div>
              <div class="run" aria-hidden="true">${chips}</div>
            </div>
          </div>
        `;
      }).join("");

      // Wire click events
      document.querySelectorAll(".chip").forEach(btn => {
        btn.addEventListener("click", () => openFocus(btn.getAttribute("data-id")));
      });
    }

    function chipHTML(q, idx){
      const isFav = favorites.has(q.id);
      const dotClass = pickDot(idx);
      const short = q.text.length > 120 ? (q.text.slice(0,120) + "…") : q.text;
      const meta = `${q.author || "—"} • ${q.book}${q.cite ? " " + q.cite : ""}${isFav ? " • ★" : ""}`;
      return `
        <div class="chip" role="button" tabindex="0" data-id="${escapeHtml(q.id)}" title="Click to open">
          <span class="dot ${dotClass}"></span>
          <div style="min-width:0;">
            <div class="qtext">“${escapeHtml(short)}”</div>
            <div class="meta">${escapeHtml(meta)}</div>
          </div>
        </div>
      `;
    }

    function openFocus(id){
      const list = filtered();
      const q = list.find(x => x.id === id) || QUOTES.find(x => x.id === id);
      if(!q) return;

      currentId = q.id;
      els.mTitle.textContent = q.book || "Focus";
      els.mQuote.textContent = `“${q.text}”`;

      const fav = favorites.has(q.id);
      els.mMeta.innerHTML = `
        <span class="pill">${escapeHtml(q.author || "—")}</span>
        <span class="pill">${escapeHtml(q.book || "—")}</span>
        <span class="pill">${escapeHtml(q.cite || "—")}</span>
        <span class="pill">${fav ? "★ Saved" : "☆ Not saved"}</span>
      `;
      els.mFav.textContent = fav ? "Unfavorite" : "Favorite";

      els.overlay.classList.add("show");
      els.overlay.setAttribute("aria-hidden","false");
    }

    function closeFocus(){
      els.overlay.classList.remove("show");
      els.overlay.setAttribute("aria-hidden","true");
    }

    function toggleFavorite(id){
      if(!id) return;
      if(favorites.has(id)) favorites.delete(id);
      else favorites.add(id);
      storage.setFavs(Array.from(favorites));
      showToast(favorites.has(id) ? "Saved" : "Removed");
      render();

      // Update modal button text if open on same quote
      if(currentId === id){
        els.mFav.textContent = favorites.has(id) ? "Unfavorite" : "Favorite";
      }
    }

    function fallbackCopy(text){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); }catch(e){}
      document.body.removeChild(ta);
    }

    async function copyQuote(id){
      const q = QUOTES.find(x => x.id === id) || filtered()[0];
      if(!q) return;

      const cite = q.cite ? " " + q.cite : "";
      const author = q.author ? q.author + ", " : "";
      const text = `"${q.text}" — ${author}${q.book}${cite}`.trim();

      try{
        if(navigator.clipboard && navigator.clipboard.writeText) await navigator.clipboard.writeText(text);
        else fallbackCopy(text);
        showToast("Copied");
      }catch{
        fallbackCopy(text);
        showToast("Copied");
      }
    }

    function shufflePick(){
      const list = filtered();
      if(list.length === 0) return;
      const pick = list[Math.floor(Math.random() * list.length)];
      openFocus(pick.id);
      showToast("Shuffled");
    }

    function nextInFocus(){
      const list = filtered();
      if(list.length === 0) return;
      const idx = Math.max(0, list.findIndex(x => x.id === currentId));
      const next = list[(idx + 1) % list.length];
      openFocus(next.id);
    }

    function toggleTheme(){
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      const next = cur === "light" ? "dark" : "light";
      if(next === "light") document.documentElement.setAttribute("data-theme","light");
      else document.documentElement.removeAttribute("data-theme");
      storage.setTheme(next);
      showToast("Theme");
    }

    function initTheme(){
      const t = storage.getTheme();
      if(t === "light") document.documentElement.setAttribute("data-theme","light");
      else document.documentElement.removeAttribute("data-theme");
    }

    function wire(){
      els.search.addEventListener("input", render);
      els.book.addEventListener("change", render);
      els.view.addEventListener("change", render);

      els.theme.addEventListener("click", toggleTheme);
      els.shuffle.addEventListener("click", shufflePick);
      els.copy.addEventListener("click", () => copyQuote(currentId));
      els.fav.addEventListener("click", () => toggleFavorite(currentId));

      els.close.addEventListener("click", closeFocus);
      els.overlay.addEventListener("click", (e) => { if(e.target === els.overlay) closeFocus(); });

      els.mCopy.addEventListener("click", () => copyQuote(currentId));
      els.mFav.addEventListener("click", () => toggleFavorite(currentId));
      els.mNext.addEventListener("click", nextInFocus);

      window.addEventListener("keydown", (e) => {
        if(e.target && (e.target.tagName === "INPUT" || e.target.tagName === "SELECT")) return;
        if(e.key === "Escape") closeFocus();
      });
    }

    (function boot(){
      initTheme();
      buildBookFilter(QUOTES);
      wire();
      render();
    })();
  </script>
</body>
</html>
