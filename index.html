<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="A poster-style quote gallery with masonry tiles and a bottom toolbar." />
  <title>Signal & Study</title>

  <!-- Totally different fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@500;700;900&family=Space+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      /* New look: bright editorial + paper + loud accents */
      --bg:#f7f5f0;
      --ink:#101015;
      --soft:#ffffff;
      --line: rgba(16,16,21,.12);
      --muted: rgba(16,16,21,.62);

      --accent:#ff2d55;     /* neon pink */
      --accent2:#2de2e6;    /* cyan */
      --accent3:#ffd60a;    /* yellow */

      --shadow: 0 12px 28px rgba(0,0,0,.12);
      --shadow2: 0 18px 46px rgba(0,0,0,.16);

      --r: 14px; /* sharper corners */
      --headline: "Unbounded", system-ui, sans-serif;
      --body: "Inter", system-ui, sans-serif;
      --mono: "Space Mono", ui-monospace, Menlo, Consolas, monospace;
    }

    [data-theme="noir"]{
      --bg:#0b0b10;
      --ink:#f4f3f8;
      --soft:#12121a;
      --line: rgba(244,243,248,.14);
      --muted: rgba(244,243,248,.62);
      --shadow: 0 12px 28px rgba(0,0,0,.55);
      --shadow2: 0 18px 46px rgba(0,0,0,.70);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: var(--bg);
      color: var(--ink);
      font-family: var(--body);
    }

    /* Big poster header (totally different from your others) */
    .hero{
      position: relative;
      padding: 26px 18px 14px;
      border-bottom: 1px solid var(--line);
      overflow:hidden;
    }
    .hero::before{
      content:"";
      position:absolute;
      inset:-120px -120px auto -120px;
      height: 340px;
      background:
        radial-gradient(240px 240px at 15% 40%, rgba(255,45,85,.35), transparent 60%),
        radial-gradient(260px 260px at 55% 20%, rgba(45,226,230,.28), transparent 60%),
        radial-gradient(260px 260px at 85% 65%, rgba(255,214,10,.25), transparent 60%);
      filter: blur(2px);
      pointer-events:none;
    }

    .heroInner{
      max-width: 1150px;
      margin: 0 auto;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      position:relative;
      z-index:1;
    }

    .brand h1{
      font-family: var(--headline);
      margin:0;
      font-size: clamp(26px, 3.6vw, 52px);
      line-height: 1.02;
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }
    .brand p{
      margin: 10px 0 0;
      max-width: 70ch;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.45;
    }

    .stamp{
      font-family: var(--mono);
      border: 1px solid var(--line);
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.55);
      box-shadow: var(--shadow);
      white-space: nowrap;
      font-size: 12px;
    }
    [data-theme="noir"] .stamp{ background: rgba(255,255,255,.06); }

    /* Filter strip (no dropdown bar like your others) */
    .filters{
      max-width: 1150px;
      margin: 14px auto 0;
      padding: 0 18px 14px;
      display:grid;
      grid-template-columns: 1.4fr .8fr .8fr;
      gap: 10px;
    }
    @media (max-width: 920px){
      .filters{ grid-template-columns: 1fr; }
      .heroInner{ flex-direction:column; align-items:flex-start; }
    }

    .field label{
      display:block;
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0 0 6px 4px;
    }

    input, select{
      width:100%;
      padding: 12px 12px;
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: var(--soft);
      color: var(--ink);
      outline:none;
      font-size: 14px;
      box-shadow: var(--shadow);
    }
    [data-theme="noir"] input,
    [data-theme="noir"] select{
      background: var(--soft);
    }

    input:focus, select:focus{
      border-color: rgba(255,45,85,.65);
      box-shadow: 0 0 0 4px rgba(255,45,85,.16), var(--shadow);
    }

    /* Masonry grid: new vibe */
    .gridWrap{
      max-width: 1150px;
      margin: 0 auto;
      padding: 12px 18px 110px;
    }
    .masonry{
      column-count: 3;
      column-gap: 14px;
    }
    @media (max-width: 980px){ .masonry{ column-count: 2; } }
    @media (max-width: 620px){ .masonry{ column-count: 1; } }

    .tile{
      break-inside: avoid;
      display:block;
      margin: 0 0 14px;
      border-radius: var(--r);
      border: 1px solid var(--line);
      background: var(--soft);
      box-shadow: var(--shadow2);
      overflow:hidden;
      position:relative;
      cursor:pointer;
      transition: transform .08s ease;
    }
    .tile:active{ transform: translateY(1px); }

    .ribbon{
      height: 8px;
      background: linear-gradient(90deg, var(--accent), var(--accent2), var(--accent3));
    }

    .tileBody{
      padding: 14px 14px 12px;
    }

    .quote{
      margin:0;
      font-size: 18px;
      line-height: 1.35;
      letter-spacing: -0.01em;
    }

    .meta{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      align-items:center;
      color: var(--muted);
      font-family: var(--mono);
      font-size: 11px;
    }

    .pill{
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.55);
    }
    [data-theme="noir"] .pill{ background: rgba(255,255,255,.06); }

    .tagRow{
      margin-top: 10px;
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
    }
    .tag{
      font-family: var(--mono);
      font-size: 11px;
      border: 1px dashed var(--line);
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--muted);
      background: rgba(0,0,0,.02);
    }
    [data-theme="noir"] .tag{ background: rgba(255,255,255,.06); }

    .favMark{
      position:absolute;
      top: 10px;
      right: 10px;
      font-family: var(--headline);
      font-size: 14px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.72);
      box-shadow: var(--shadow);
      display:none;
    }
    [data-theme="noir"] .favMark{ background: rgba(255,255,255,.08); }
    .tile.fav .favMark{ display:block; }

    /* Bottom toolbar (new vs your side buttons / top bars) */
    .dock{
      position: fixed;
      left: 50%;
      bottom: 14px;
      transform: translateX(-50%);
      width: min(980px, calc(100% - 24px));
      border-radius: 20px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      z-index: 999;
    }
    [data-theme="noir"] .dock{
      background: rgba(18,18,26,.72);
    }

    .dockLeft{
      display:flex;
      gap:10px;
      align-items:center;
      min-width: 140px;
    }

    .badge{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      padding: 8px 10px;
      border: 1px solid var(--line);
      border-radius: 999px;
      white-space:nowrap;
    }

    .dockBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Completely different button style: squared, bold, no gradients */
    .btn{
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .06em;
      text-transform: uppercase;
      padding: 10px 12px;
      border-radius: 12px;
      border: 2px solid var(--ink);
      background: transparent;
      color: var(--ink);
      cursor:pointer;
      transition: background .12s ease, color .12s ease, transform .08s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn:hover{ background: var(--ink); color: var(--bg); }

    .btn.pink{ border-color: var(--accent); color: var(--accent); }
    .btn.pink:hover{ background: var(--accent); color: #fff; }

    .btn.cyan{ border-color: var(--accent2); color: var(--accent2); }
    .btn.cyan:hover{ background: var(--accent2); color: #001014; }

    .btn.sun{ border-color: var(--accent3); color: var(--sun); }
    .btn.sun:hover{ background: var(--accent3); color: #101015; }

    .btn.ghost{
      border-color: var(--line);
      color: var(--muted);
    }
    .btn.ghost:hover{
      background: rgba(0,0,0,.06);
      color: var(--ink);
    }

    /* Modal */
    .overlay{
      position: fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.62);
      z-index: 1000;
      padding: 18px;
    }
    .overlay.show{ display:flex; }

    .modal{
      width: min(900px, 100%);
      border-radius: 22px;
      border: 1px solid var(--line);
      background: var(--soft);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }

    .modalTop{
      padding: 12px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(90deg, rgba(255,45,85,.10), rgba(45,226,230,.08), rgba(255,214,10,.10));
    }

    .modalTop strong{
      font-family: var(--headline);
      text-transform: uppercase;
      letter-spacing:-.01em;
      font-size: 14px;
    }

    .modalBody{ padding: 14px; }

    .big{
      font-family: var(--headline);
      font-size: clamp(22px, 2.8vw, 44px);
      line-height: 1.12;
      margin: 0;
    }

    .modalMeta{
      margin-top: 12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
    }

    .modalBtns{
      margin-top: 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 92px;
      transform: translateX(-50%);
      background: rgba(16,16,21,.92);
      color: white;
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 13px;
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index: 1100;
      max-width: min(980px, calc(100% - 24px));
      text-align:center;
      font-family: var(--mono);
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }
  </style>
</head>

<body>
  <section class="hero">
    <div class="heroInner">
      <div class="brand">
        <h1>Signal &amp; Study</h1>
        <p>A loud, poster-style quote wall. Click any tile to open it in Focus. Save favorites, shuffle, and add your own verified quotes from other books.</p>
      </div>
      <div class="stamp" id="stamp">Edition: Web • Layout: Masonry</div>
    </div>
  </section>

  <section class="filters">
    <div class="field">
      <label for="search">Search</label>
      <input id="search" placeholder="Try: prayer, questions, study, reading…" />
    </div>
    <div class="field">
      <label for="book">Book</label>
      <select id="book"></select>
    </div>
    <div class="field">
      <label for="view">View</label>
      <select id="view">
        <option value="all">All</option>
        <option value="favorites">Favorites</option>
        <option value="user">User-added</option>
      </select>
    </div>
  </section>

  <main class="gridWrap">
    <div class="masonry" id="grid"></div>
  </main>

  <div class="dock">
    <div class="dockLeft">
      <div class="badge" id="countBadge">0 tiles</div>
    </div>
    <div class="dockBtns">
      <button class="btn ghost" id="themeBtn">Theme</button>
      <button class="btn cyan" id="shuffleBtn">Shuffle</button>
      <button class="btn pink" id="copyBtn">Copy</button>
      <button class="btn sun" id="favBtn">Favorite</button>
      <button class="btn" id="addBtn">Add Quote</button>
    </div>
  </div>

  <!-- Focus modal -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <strong id="modalTitle">Focus</strong>
        <button class="btn ghost" id="closeBtn" style="padding:8px 10px;border-width:1px;">Close</button>
      </div>
      <div class="modalBody">
        <p class="big" id="modalQuote"></p>
        <div class="modalMeta" id="modalMeta"></div>
        <div class="modalBtns">
          <button class="btn cyan" id="modalCopy">Copy</button>
          <button class="btn sun" id="modalFav">Favorite</button>
          <button class="btn pink" id="modalNext">Next</button>
        </div>
        <div style="margin-top:12px;color:var(--muted);font-family:var(--mono);font-size:12px;">
          Tip: Use “Add Quote” to paste exact lines from other books you’ve read.
        </div>
      </div>
    </div>
  </div>

  <!-- Add Quote modal -->
  <div class="overlay" id="addOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <strong>Add Your Quote</strong>
        <button class="btn ghost" id="addClose" style="padding:8px 10px;border-width:1px;">Close</button>
      </div>
      <div class="modalBody">
        <div class="field">
          <label>Quote (paste exact text)</label>
          <input id="aq_text" placeholder='Example: "..."' />
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Book</label>
          <input id="aq_book" placeholder="Book title" />
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Author</label>
          <input id="aq_author" placeholder="Author name" />
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Citation (optional)</label>
          <input id="aq_cite" placeholder="(Author page#) or chapter" />
        </div>
        <div class="field" style="margin-top:10px;">
          <label>Tags (comma separated)</label>
          <input id="aq_tags" placeholder="reading, prayer, questions" />
        </div>

        <div class="modalBtns" style="margin-top:14px;">
          <button class="btn pink" id="aq_save">Save</button>
          <button class="btn ghost" id="aq_clear">Clear</button>
        </div>

        <div style="margin-top:10px;color:var(--muted);font-family:var(--mono);font-size:12px;">
          Saved quotes stay in your browser (localStorage).
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Your quote included EXACTLY as typed (unchanged).
    // Other entries include:
    // - Original thematic lines (labeled "Original")
    // - Pre-labeled "Paste your quote" tiles for other books (so you can add real quotes safely)

    const baseQuotes = [
      // Original tiles (not attributed to books)
      { id:"o1", text:"He studied like a person trying to build a doorway out of facts.", book:"Original", author:"—", cite:"", tags:["study","seeking"] },
      { id:"o2", text:"Prayer was the only language he had left for the questions.", book:"Original", author:"—", cite:"", tags:["prayer","questions"] },
      { id:"o3", text:"Reading didn’t calm him—it sharpened the need to know.", book:"Original", author:"—", cite:"", tags:["reading","questions"] },

      // Your required quote (unchanged)
      { id:"wiesel-4", text:"I read, I studied, I prayed... I wanted to ask him the questions that thronged my mind", book:"Night", author:"Elie Wiesel", cite:"(Wiesel 4)", tags:["reading","study","prayer","questions"] },

      { id:"o4", text:"He wanted answers, but he learned to live inside the asking.", book:"Original", author:"—", cite:"", tags:["questions","faith"] },
      { id:"o5", text:"He read as if the next sentence might finally explain the world.", book:"Original", author:"—", cite:"", tags:["reading","truth"] },

      // “Different books” slots (you paste exact quotes later)
      { id:"slot1", text:"PASTE A QUOTE HERE", book:"The Book Thief", author:"Markus Zusak", cite:"", tags:["slot","war","reading"], isSlot:true },
      { id:"slot2", text:"PASTE A QUOTE HERE", book:"The Human Comedy", author:"William Saroyan", cite:"", tags:["slot","family","duty"], isSlot:true },
      { id:"slot3", text:"PASTE A QUOTE HERE", book:"Your choice", author:"Your choice", cite:"", tags:["slot"], isSlot:true },
    ];

    const els = {
      search: document.getElementById("search"),
      book: document.getElementById("book"),
      view: document.getElementById("view"),
      grid: document.getElementById("grid"),
      countBadge: document.getElementById("countBadge"),

      themeBtn: document.getElementById("themeBtn"),
      shuffleBtn: document.getElementById("shuffleBtn"),
      copyBtn: document.getElementById("copyBtn"),
      favBtn: document.getElementById("favBtn"),
      addBtn: document.getElementById("addBtn"),

      overlay: document.getElementById("overlay"),
      closeBtn: document.getElementById("closeBtn"),
      modalTitle: document.getElementById("modalTitle"),
      modalQuote: document.getElementById("modalQuote"),
      modalMeta: document.getElementById("modalMeta"),
      modalCopy: document.getElementById("modalCopy"),
      modalFav: document.getElementById("modalFav"),
      modalNext: document.getElementById("modalNext"),

      addOverlay: document.getElementById("addOverlay"),
      addClose: document.getElementById("addClose"),
      aq_text: document.getElementById("aq_text"),
      aq_book: document.getElementById("aq_book"),
      aq_author: document.getElementById("aq_author"),
      aq_cite: document.getElementById("aq_cite"),
      aq_tags: document.getElementById("aq_tags"),
      aq_save: document.getElementById("aq_save"),
      aq_clear: document.getElementById("aq_clear"),

      toast: document.getElementById("toast"),
    };

    const storage = {
      getTheme: () => localStorage.getItem("ss_theme") || "paper",
      setTheme: (t) => localStorage.setItem("ss_theme", t),
      getFavs: () => {
        try { return JSON.parse(localStorage.getItem("ss_favs") || "[]"); } catch { return []; }
      },
      setFavs: (arr) => localStorage.setItem("ss_favs", JSON.stringify(arr)),
      getUser: () => {
        try { return JSON.parse(localStorage.getItem("ss_user") || "[]"); } catch { return []; }
      },
      setUser: (arr) => localStorage.setItem("ss_user", JSON.stringify(arr)),
    };

    let favorites = new Set(storage.getFavs());
    let userQuotes = storage.getUser();
    let quotes = [];
    let currentId = null;

    function showToast(msg){
      els.toast.textContent = msg;
      els.toast.classList.add("show");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => els.toast.classList.remove("show"), 1400);
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, s => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      })[s]);
    }

    function uniq(arr){ return Array.from(new Set(arr)).sort((a,b)=>a.localeCompare(b)); }

    function rebuildQuotes(){
      // Put user quotes into the mix but NOT first
      quotes = [
        ...baseQuotes.slice(0, 2),
        ...userQuotes,
        ...baseQuotes.slice(2)
      ];
    }

    function buildBookFilter(list){
      const books = uniq(list.map(q => q.book));
      els.book.innerHTML =
        `<option value="">All books</option>` +
        books.map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join("");
    }

    function matches(q, item){
      if(!q) return true;
      const hay = [item.text, item.book, item.author, item.cite || "", ...(item.tags||[])].join(" ").toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function filtered(){
      const q = (els.search.value || "").trim();
      const book = els.book.value;
      const view = els.view.value;

      return quotes.filter(item => {
        if(book && item.book !== book) return false;
        if(view === "favorites" && !favorites.has(item.id)) return false;
        if(view === "user" && !item.isUser) return false;
        return matches(q, item);
      });
    }

    function render(){
      const list = filtered();

      els.countBadge.textContent = `${list.length} tiles`;

      if(!currentId || !list.some(x => x.id === currentId)){
        currentId = list[0]?.id || null;
      }

      if(list.length === 0){
        els.grid.innerHTML = `
          <div class="tile">
            <div class="ribbon"></div>
            <div class="tileBody">
              <p class="quote">No results. Clear your filters.</p>
              <div class="meta"><span class="pill">Tip</span><span>Try removing the book filter.</span></div>
            </div>
          </div>`;
        return;
      }

      els.grid.innerHTML = list.map(q => {
        const isFav = favorites.has(q.id);
        const tags = (q.tags||[]).slice(0, 5);
        const title = q.book || "—";
        const author = q.author || "—";
        const cite = q.cite || "";

        return `
          <article class="tile ${isFav ? "fav" : ""}" data-id="${escapeHtml(q.id)}">
            <div class="ribbon"></div>
            <div class="favMark">★</div>
            <div class="tileBody">
              <p class="quote">“${escapeHtml(q.text)}”</p>
              <div class="meta">
                <span class="pill">${escapeHtml(title)}</span>
                <span class="pill">${escapeHtml(author)}</span>
                ${cite ? `<span class="pill">${escapeHtml(cite)}</span>` : ""}
                ${q.isSlot ? `<span class="pill" style="border-color:var(--accent);color:var(--accent);">PASTE ME</span>` : ""}
                ${q.isUser ? `<span class="pill" style="border-color:var(--accent2);color:var(--accent2);">USER</span>` : ""}
              </div>
              <div class="tagRow">
                ${tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join("")}
              </div>
            </div>
          </article>
        `;
      }).join("");
    }

    function openFocus(id){
      const list = filtered();
      const q = list.find(x => x.id === id) || quotes.find(x => x.id === id);
      if(!q) return;

      currentId = q.id;
      els.modalTitle.textContent = q.book || "Focus";
      els.modalQuote.textContent = `“${q.text}”`;
      els.modalMeta.innerHTML = `
        <span class="pill">${escapeHtml(q.author || "—")}</span>
        ${q.cite ? `<span class="pill">${escapeHtml(q.cite)}</span>` : `<span class="pill">—</span>`}
        <span class="pill">${favorites.has(q.id) ? "★ Favorited" : "☆ Not saved"}</span>
      `;

      els.modalFav.textContent = favorites.has(q.id) ? "Unfavorite" : "Favorite";

      els.overlay.classList.add("show");
      els.overlay.setAttribute("aria-hidden","false");
    }

    function closeFocus(){
      els.overlay.classList.remove("show");
      els.overlay.setAttribute("aria-hidden","true");
    }

    function toggleFavorite(id){
      if(!id) return;
      if(favorites.has(id)) favorites.delete(id);
      else favorites.add(id);
      storage.setFavs(Array.from(favorites));
      showToast(favorites.has(id) ? "Favorited" : "Removed");
      render();
      // update modal button text if open
      els.modalFav.textContent = favorites.has(id) ? "Unfavorite" : "Favorite";
    }

    async function copyCurrent(){
      const q = quotes.find(x => x.id === currentId) || filtered()[0];
      if(!q) return;
      const cite = q.cite ? " " + q.cite : "";
      const author = q.author ? q.author + ", " : "";
      const text = `"${q.text}" — ${author}${q.book}${cite}`.trim();

      try{
        if(navigator.clipboard && navigator.clipboard.writeText) await navigator.clipboard.writeText(text);
        else fallbackCopy(text);
        showToast("Copied");
      }catch{
        fallbackCopy(text);
        showToast("Copied");
      }
    }

    function fallbackCopy(text){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); }catch(e){}
      document.body.removeChild(ta);
    }

    function shuffle(){
      const list = filtered();
      if(list.length === 0) return;
      const pick = list[Math.floor(Math.random() * list.length)];
      openFocus(pick.id);
      showToast("Shuffled");
    }

    function nextInFocus(){
      const list = filtered();
      if(list.length === 0) return;
      const idx = Math.max(0, list.findIndex(x => x.id === currentId));
      const next = list[(idx + 1) % list.length];
      openFocus(next.id);
    }

    function toggleTheme(){
      const cur = document.documentElement.getAttribute("data-theme") || "paper";
      const next = cur === "noir" ? "paper" : "noir";
      if(next === "noir") document.documentElement.setAttribute("data-theme","noir");
      else document.documentElement.removeAttribute("data-theme");
      storage.setTheme(next);
      showToast("Theme changed");
    }

    function initTheme(){
      const t = storage.getTheme();
      if(t === "noir") document.documentElement.setAttribute("data-theme","noir");
      else document.documentElement.removeAttribute("data-theme");
    }

    function openAdd(){
      els.addOverlay.classList.add("show");
      els.addOverlay.setAttribute("aria-hidden","false");
    }
    function closeAdd(){
      els.addOverlay.classList.remove("show");
      els.addOverlay.setAttribute("aria-hidden","true");
    }
    function clearAdd(){
      els.aq_text.value = "";
      els.aq_book.value = "";
      els.aq_author.value = "";
      els.aq_cite.value = "";
      els.aq_tags.value = "";
    }

    function saveUserQuote(){
      const text = (els.aq_text.value || "").trim();
      const book = (els.aq_book.value || "").trim() || "User quote";
      const author = (els.aq_author.value || "").trim() || "—";
      const cite = (els.aq_cite.value || "").trim();
      const tags = (els.aq_tags.value || "").split(",").map(s => s.trim()).filter(Boolean);

      if(!text){
        showToast("Paste a quote first");
        return;
      }

      const id = "u_" + Math.random().toString(16).slice(2);
      userQuotes.unshift({ id, text, book, author, cite, tags, isUser:true });
      storage.setUser(userQuotes);

      rebuildQuotes();
      buildBookFilter(quotes);
      render();
      closeAdd();
      showToast("Saved quote");
      clearAdd();
    }

    function wire(){
      els.search.addEventListener("input", render);
      els.book.addEventListener("change", render);
      els.view.addEventListener("change", render);

      els.grid.addEventListener("click", (e) => {
        const tile = e.target.closest(".tile");
        if(!tile) return;
        openFocus(tile.getAttribute("data-id"));
      });

      els.themeBtn.addEventListener("click", toggleTheme);
      els.shuffleBtn.addEventListener("click", shuffle);
      els.copyBtn.addEventListener("click", copyCurrent);
      els.favBtn.addEventListener("click", () => toggleFavorite(currentId));
      els.addBtn.addEventListener("click", openAdd);

      // Focus modal
      els.closeBtn.addEventListener("click", closeFocus);
      els.overlay.addEventListener("click", (e) => { if(e.target === els.overlay) closeFocus(); });
      els.modalCopy.addEventListener("click", copyCurrent);
      els.modalFav.addEventListener("click", () => toggleFavorite(currentId));
      els.modalNext.addEventListener("click", nextInFocus);

      // Add modal
      els.addClose.addEventListener("click", closeAdd);
      els.addOverlay.addEventListener("click", (e) => { if(e.target === els.addOverlay) closeAdd(); });
      els.aq_clear.addEventListener("click", clearAdd);
      els.aq_save.addEventListener("click", saveUserQuote);

      // Minimal keyboard (no banner shown)
      window.addEventListener("keydown", (e) => {
        if(e.target && (e.target.tagName === "INPUT" || e.target.tagName === "SELECT")) return;
        if(e.key === "Escape"){ closeFocus(); closeAdd(); }
      });
    }

    (function boot(){
      initTheme();
      rebuildQuotes();
      buildBookFilter(quotes);
      currentId = quotes.find(q => q.id !== "wiesel-4")?.id || quotes[0]?.id || null;
      wire();
      render();
    })();
  </script>
</body>
</html>
